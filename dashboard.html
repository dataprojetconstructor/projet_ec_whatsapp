<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Gestion Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: white; }
        * { font-style: normal !important; }
        [x-cloak] { display: none !important; }
        .squircle { border-radius: 28%; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .admin-card { background-color: #050505; border: 1px solid rgba(255, 255, 255, 0.03); }
        .admin-input { background-color: #0a0a0a; border: 1px solid rgba(255, 255, 255, 0.05); color: white; }
        .admin-input:focus { border-color: rgba(255, 255, 255, 0.2); outline: none; }
    </style>

    <script>
        function dashboardApp() {
            return {
                sb: null, user: null, shopInfo: {}, products: [], stats: { views: 0, clicks: 0 },
                showAdd: false, uploading: false, files: [], previews: [],
                form: { nom: '', desc: '', prix: '', sizes: '' },

                async init() {
                    const S_URL = "https://foainwlpbpbttqqzuina.supabase.co";
                    const S_KEY = "sb_publishable_Zg_FjHfW5v4m-yiI8FQNYA_oMtpCq2d";
                    this.sb = supabase.createClient(S_URL, S_KEY);

                    const { data: { session } } = await this.sb.auth.getSession();
                    if (!session) { window.location.href = "login.html"; return; }
                    this.user = session.user;
                    
                    await this.fetchData();
                },

                async fetchData() {
                    // Infos boutique
                    const { data: shop } = await this.sb.from('boutiques').select('*').eq('id', this.user.id).single();
                    this.shopInfo = shop || {};

                    // Produits
                    const { data: ps } = await this.sb.from('produits').select('*').eq('boutique_id', this.user.id).order('created_at', { ascending: false });
                    this.products = ps || [];

                    // Stats
                    const { count: v } = await this.sb.from('statistiques').select('*', { count: 'exact', head: true }).eq('boutique_id', this.user.id).eq('action_type', 'vue');
                    const { count: c } = await this.sb.from('statistiques').select('*', { count: 'exact', head: true }).eq('boutique_id', this.user.id).eq('action_type', 'clic_wa');
                    this.stats = { views: v || 0, clicks: c || 0 };
                },

                handleFiles(e) {
                    this.files = Array.from(e.target.files);
                    this.previews = this.files.map(f => URL.createObjectURL(f));
                },

                async addProduct() {
                    this.uploading = true;
                    try {
                        let urls = [];
                        for (let f of this.files) {
                            const name = `${Date.now()}-${f.name}`;
                            const { data } = await this.sb.storage.from('produits-photos').upload(`${this.user.id}/${name}`, f);
                            const { data: { publicUrl } } = this.sb.storage.from('produits-photos').getPublicUrl(`${this.user.id}/${name}`);
                            urls.push(publicUrl);
                        }

                        await this.sb.from('produits').insert([{
                            boutique_id: this.user.id,
                            nom: this.form.nom.toUpperCase(),
                            description: this.form.desc,
                            prix: parseFloat(this.form.prix),
                            tailles: this.form.sizes ? this.form.sizes.split(',').map(s => s.trim()) : [],
                            images: urls
                        }]);

                        this.showAdd = false;
                        this.form = { nom: '', desc: '', prix: '', sizes: '' };
                        this.files = []; this.previews = [];
                        await this.fetchData();
                    } catch (e) { alert(e.message); }
                    this.uploading = false;
                },

                async togglePin(p) {
                    await this.sb.from('produits').update({ is_pinned: !p.is_pinned }).eq('id', p.id);
                    await this.fetchData();
                },

                async deleteProd(id) {
                    if (confirm('SUPPRIMER CET ARTICLE DÉFINITIVEMENT ?')) {
                        await this.sb.from('produits').delete().eq('id', id);
                        await this.fetchData();
                    }
                },

                async logout() {
                    await this.sb.auth.signOut();
                    window.location.href = "login.html";
                },

                copyLink() {
                    const link = window.location.origin + window.location.pathname.replace('dashboard.html', 'index.html') + '?id=' + this.user.id;
                    navigator.clipboard.writeText(link);
                    alert("LIEN DE LA BOUTIQUE COPIÉ !");
                },

                formatPrice(p) { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF', maximumFractionDigits: 0 }).format(p); }
            }
        }
    </script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="dashboardApp()" class="min-h-screen pb-32">

    <!-- NAV -->
    <nav class="sticky top-0 z-30 bg-black/80 backdrop-blur-xl border-b border-white/5 p-6 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-tr from-orange-600 via-rose-600 to-yellow-500 squircle flex items-center justify-center text-white font-black text-[10px]">D</div>
            <h1 class="font-black text-xs uppercase tracking-[0.2em]" x-text="shopInfo.nom_boutique"></h1>
        </div>
        <button @click="logout" class="text-[9px] font-black uppercase text-neutral-500 hover:text-white">Déconnexion</button>
    </nav>

    <main class="max-w-md mx-auto p-6 space-y-10">
        
        <!-- ANALYTICS -->
        <section class="grid grid-cols-2 gap-4">
            <div class="admin-card p-8 rounded-[2.5rem] text-center">
                <span class="text-4xl font-black block tracking-tighter" x-text="stats.views"></span>
                <span class="text-[8px] font-black uppercase tracking-[0.3em] text-neutral-600 mt-2 block">Vues Page</span>
            </div>
            <div class="admin-card p-8 rounded-[2.5rem] text-center border-orange-500/10">
                <span class="text-4xl font-black block tracking-tighter text-orange-500" x-text="stats.clicks"></span>
                <span class="text-[8px] font-black uppercase tracking-[0.3em] text-neutral-600 mt-2 block">Clics WhatsApp</span>
            </div>
        </section>

        <!-- LIEN BIO -->
        <section class="admin-card p-6 rounded-[2rem] flex items-center justify-between">
            <div class="flex-1 truncate mr-4">
                <span class="text-[8px] font-black text-neutral-600 uppercase block mb-1">Lien de votre boutique</span>
                <span class="text-[10px] font-bold text-white opacity-50 italic">index.html?id=...</span>
            </div>
            <button @click="copyLink" class="bg-white text-black px-5 py-2 rounded-xl font-black text-[10px] uppercase tracking-widest">Copier</button>
        </section>

        <!-- LISTE ARTICLES -->
        <section class="space-y-4">
            <div class="flex justify-between items-end px-2">
                <h2 class="text-[10px] font-black uppercase tracking-[0.3em] text-neutral-500">Mon Catalogue</h2>
                <span class="text-[10px] font-black text-neutral-700" x-text="products.length + ' ARTICLES'"></span>
            </div>

            <div class="space-y-3">
                <template x-for="p in products" :key="p.id">
                    <div class="admin-card p-4 rounded-[2rem] flex items-center gap-4">
                        <img :src="p.images[0]" class="w-16 h-16 rounded-[1.2rem] object-cover bg-neutral-900 border border-white/5">
                        <div class="flex-1">
                            <h3 class="font-black text-[11px] uppercase tracking-tight truncate w-32" x-text="p.nom"></h3>
                            <p class="text-[10px] font-bold text-neutral-500 mt-1" x-text="formatPrice(p.prix)"></p>
                        </div>
                        <div class="flex gap-2">
                            <button @click="togglePin(p)" :class="p.is_pinned ? 'bg-orange-600 text-white' : 'bg-neutral-900 text-neutral-700'" class="p-3 rounded-xl transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                            </button>
                            <button @click="deleteProd(p.id)" class="p-3 bg-neutral-900 text-neutral-700 hover:text-red-500 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </section>
    </main>

    <!-- BOUTON AJOUT FIXE -->
    <button @click="showAdd = true" class="fixed bottom-8 right-8 bg-white text-black p-5 rounded-[2.5rem] shadow-[0_20px_50px_rgba(255,255,255,0.1)] active:scale-95 transition-all z-40">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
    </button>

    <!-- MODALE AJOUT (NOIR ÉCLAIRÉ) -->
    <div x-show="showAdd" x-cloak class="fixed inset-0 z-50 bg-black overflow-y-auto px-6" x-transition:enter="transition ease-out duration-300 transform" x-transition:enter-start="translate-y-full">
        <div class="max-w-md mx-auto pt-10 pb-20">
            <div class="flex justify-between items-center mb-12">
                <h2 class="text-3xl font-black uppercase tracking-tighter">Nouvel Article</h2>
                <button @click="showAdd = false" class="text-[10px] font-black uppercase tracking-widest text-neutral-500">Fermer</button>
            </div>

            <form @submit.prevent="addProduct" class="space-y-8">
                <!-- Zone Photo -->
                <div class="admin-card p-8 rounded-[2.5rem] border-dashed border-neutral-800 text-center">
                    <input type="file" @change="handleFiles" multiple accept="image/*" class="hidden" id="fileInput">
                    <label for="fileInput" class="cursor-pointer">
                        <div class="text-orange-500 font-black text-xs uppercase tracking-widest mb-4">Ajouter des photos</div>
                        <div class="flex gap-2 justify-center overflow-x-auto no-scrollbar">
                            <template x-for="p in previews">
                                <img :src="p" class="w-20 h-20 rounded-2xl object-cover border border-white/10">
                            </template>
                            <template x-if="previews.length === 0">
                                <div class="w-20 h-20 rounded-2xl bg-neutral-900 border border-white/5 flex items-center justify-center text-neutral-700">+</div>
                            </template>
                        </div>
                    </label>
                </div>

                <div class="space-y-4">
                    <input type="text" x-model="form.nom" placeholder="NOM DE L'ARTICLE" required class="w-full admin-input rounded-2xl px-6 py-4 text-[10px] font-black tracking-widest uppercase">
                    <textarea x-model="form.desc" placeholder="DESCRIPTION" rows="3" class="w-full admin-input rounded-2xl px-6 py-4 text-[10px] font-black tracking-widest uppercase"></textarea>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" x-model="form.prix" placeholder="PRIX (XOF)" required class="admin-input rounded-2xl px-6 py-4 text-[10px] font-black tracking-widest uppercase">
                        <input type="text" x-model="form.sizes" placeholder="TAILLES (S, M, L)" class="admin-input rounded-2xl px-6 py-4 text-[10px] font-black tracking-widest uppercase">
                    </div>
                </div>

                <button type="submit" :disabled="uploading" class="w-full bg-white text-black py-5 rounded-[2.5rem] font-black text-xs tracking-[0.2em] uppercase active:scale-95 transition-all shadow-xl disabled:opacity-50">
                    <span x-text="uploading ? 'Chargement...' : 'Publier l\'article'"></span>
                </button>
            </form>
        </div>
    </div>

</body>
</html>
