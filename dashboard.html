<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Gestion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body x-data="dashboardApp()" class="bg-gray-50 min-h-screen pb-20">

    <nav class="bg-white border-b p-6 flex justify-between items-center sticky top-0 z-10">
        <h1 class="font-black text-xl">Mon Dashboard</h1>
        <button @click="logout" class="text-zinc-400 font-bold text-xs">D√©connexion</button>
    </nav>

    <main class="max-w-md mx-auto p-6 space-y-6">
        <!-- STATS -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border">
                <span class="text-3xl font-black block" x-text="stats.views">0</span>
                <span class="text-[10px] uppercase font-black text-zinc-400">Visites</span>
            </div>
            <div class="bg-zinc-900 text-white p-6 rounded-[2rem] shadow-lg">
                <span class="text-3xl font-black block" x-text="stats.clicks">0</span>
                <span class="text-[10px] uppercase font-black text-zinc-400">Clics WA</span>
            </div>
        </div>

        <!-- LISTE PRODUITS -->
        <div class="space-y-3">
            <template x-for="p in products" :key="p.id">
                <div class="bg-white p-3 rounded-2xl flex items-center gap-4 border shadow-sm">
                    <img :src="p.images[0]" class="w-12 h-12 rounded-xl object-cover bg-gray-100">
                    <div class="flex-1">
                        <h3 class="text-sm font-bold truncate" x-text="p.nom"></h3>
                        <p class="text-xs text-zinc-400" x-text="p.prix + ' XOF'"></p>
                    </div>
                    <button @click="delProd(p.id)" class="text-red-400">üóëÔ∏è</button>
                </div>
            </template>
        </div>
    </main>

    <!-- BOUTON AJOUT -->
    <button @click="showAdd = true" class="fixed bottom-6 right-6 bg-black text-white p-5 rounded-[2rem] shadow-2xl">+</button>

    <!-- MODALE AJOUT -->
    <div x-show="showAdd" x-cloak class="fixed inset-0 bg-white z-50 p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-2xl font-black">Nouveau Produit</h2>
            <button @click="showAdd = false" class="text-zinc-400">Fermer</button>
        </div>
        <form @submit.prevent="addProd" class="space-y-4">
            <input type="file" @change="files = Array.from($event.target.files)" multiple class="text-xs">
            <input type="text" x-model="form.nom" placeholder="Nom" class="w-full p-4 bg-gray-100 rounded-2xl outline-none" required>
            <textarea x-model="form.desc" placeholder="Description" class="w-full p-4 bg-gray-100 rounded-2xl outline-none"></textarea>
            <input type="number" x-model="form.prix" placeholder="Prix" class="w-full p-4 bg-gray-100 rounded-2xl outline-none" required>
            <button type="submit" :disabled="up" class="w-full bg-black text-white py-5 rounded-2xl font-bold">
                <span x-text="up ? 'Chargement...' : 'Ajouter'"></span>
            </button>
        </form>
    </div>

    <script>
        function dashboardApp() {
            return {
                sb: null, user: null, products: [], stats: { views: 0, clicks: 0 },
                showAdd: false, up: false, files: [],
                form: { nom: '', desc: '', prix: '' },

                async init() {
                    const S_URL = "https://foainwlpbpbttqqzuina.supabase.co";
                    const S_KEY = "sb_publishable_Zg_FjHfW5v4m-yiI8FQNYA_oMtpCq2d";
                    this.sb = supabase.createClient(S_URL, S_KEY);

                    const { data: { session } } = await this.sb.auth.getSession();
                    if (!session) { window.location.href = "login.html"; return; }
                    this.user = session.user;
                    this.fetch();
                },

                async fetch() {
                    const { data: ps } = await this.sb.from('produits').select('*').eq('boutique_id', this.user.id).order('created_at', { ascending: false });
                    this.products = ps || [];
                    
                    const { count: v } = await this.sb.from('statistiques').select('*', { count: 'exact', head: true }).eq('boutique_id', this.user.id).eq('action_type', 'vue');
                    const { count: c } = await this.sb.from('statistiques').select('*', { count: 'exact', head: true }).eq('boutique_id', this.user.id).eq('action_type', 'clic_wa');
                    this.stats = { views: v || 0, clicks: c || 0 };
                },

                async addProd() {
                    this.up = true;
                    try {
                        let urls = [];
                        for (let f of this.files) {
                            const name = `${Date.now()}-${f.name}`;
                            await this.sb.storage.from('produits-photos').upload(`${this.user.id}/${name}`, f);
                            const { data: { publicUrl } } = this.sb.storage.from('produits-photos').getPublicUrl(`${this.user.id}/${name}`);
                            urls.push(publicUrl);
                        }
                        await this.sb.from('produits').insert([{ boutique_id: this.user.id, nom: this.form.nom, description: this.form.desc, prix: this.form.prix, images: urls, tailles: [] }]);
                        this.showAdd = false; this.fetch();
                    } catch (e) { alert(e.message); }
                    this.up = false;
                },

                async delProd(id) {
                    if(confirm('Supprimer ?')) { await this.sb.from('produits').delete().eq('id', id); this.fetch(); }
                },

                async logout() {
                    await this.sb.auth.signOut();
                    window.location.href = "login.html";
                }
            }
        }
    </script>
</body>
</html>
